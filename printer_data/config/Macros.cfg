[gcode_macro DISABLE_XY]
gcode:
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0

#####################################################################
#####################################################################

[gcode_macro ENABLE_ALL_MOTORS]
gcode:
    M17
#####################################################################
#####################################################################

[gcode_macro QGL_PREHEAT]
gcode:
   {% if "xyz" not in printer.toolhead.homed_axes %}
     G28
   {% endif %}
    M140 S80        ; set bed temp to 80 (no wait)
    M104 S150       ; set nozzle temp to 150 (no wait)
    M190 S80        ; wait for bed to reach 80
    M109 S150       ; wait for nozzle to reach 150
    QUAD_GANTRY_LEVEL

#####################################################################
#####################################################################

[gcode_macro BEDMESH_PREHEAT]
gcode:
   {% if "xyz" not in printer.toolhead.homed_axes %}
     G28
   {% endif %}
    M140 S80         ; set bed temp to 80 (no wait)
    M104 S150        ; set nozzle temp to 150 (no wait)
    M190 S80         ; wait for bed to reach 80
    M109 S150        ; wait for nozzle to reach 150
    BED_MESH_CALIBRATE
    
#####################################################################
#####################################################################

[gcode_macro PRINT_START]
gcode:
    # Pull bed and extruder temperatures from slicer or use defaults
    {% set BED_TEMP = params.BED|default(80)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(240)|float %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
    G28
    quad_gantry_level
    G28 Z
    
    # Cleaning the Nozzle – only if bed temp > 50°C (PETG, ASA)
    {% if BED_TEMP|int > 50 %}
      STATUS_CLEANING
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=260
      G90
      G1 X300 Y350 Z65 F6000
      M109 S260
      G4 P120000
  
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=220
      M109 S220
      CLEAN_NOZZLE
    {% endif %}

    # Cleaning the Nozzle – only if bed temp < 50°C (TPU)
    {% if BED_TEMP|int < 50 %}
      STATUS_CLEANING
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=240
      G90
      G1 X300 Y350 Z65 F6000
      M109 S240
      G4 P120000
  
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=220
      M109 S220
      CLEAN_NOZZLE
    {% endif %}
    
    # Lower the nozzle's heat to 150 for probing
    STATUS_HEATING
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150

    # Check if the bed temp is higher than 90°C - if so, trigger a heat soak.
    {% if BED_TEMP|int > 90 %}                               
      G28                                                 # Home
      SET_DISPLAY_TEXT MSG="Soak for 5 Mins"              # Display info on display
      G4 P300000                                          # Wait 5 mins for the bedtemp to stabilize                                       
    {% endif %}
    #####################################
    # Home, QGL, Bed Mesh
    STATUS_LEVELING
    G28
    G90
    BED_MESH_CLEAR
    quad_gantry_level
    G28 Z
    BED_MESH_CALIBRATE
    G0 X175 Y175 Z50 F3600
    #####################################
    # Nozzle Temp to Print Temperature
    STATUS_HEATING
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP} 
    STATUS_PRINTING
    
#####################################################################
#####################################################################

[gcode_macro PRINT_END]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0 # Heated Bed 0
    M104 S0 # Extruder 0
    M106 S0 # Part-Cooling Fan 0
    # Move nozzle away from print while retracting 10mm
    G91
    G1 X-2 Y-2 E-10 F300
    # Raise nozzle by 10mm
    G1 Z10 F3000
    G90
    G1 X340 Y340 F3600
    M84 # Disable steppers
    STATUS_COMPLETED

#####################################################################
#####################################################################

[gcode_macro CLEAN_NOZZLE]
variable_start_x: 154
variable_start_y: 349.9
variable_start_z: 12
variable_wipe_dist: -50
variable_wipe_qty: 16
variable_wipe_spd: 100
variable_raise_distance: 30

gcode:
 {% if "xyz" not in printer.toolhead.homed_axes %}
   G28
 {% endif %}
 
 G90                                            ; absolute positioning
 ## Move nozzle to start position
 G1 X{start_x} Y{start_y} F6000
 G1 Z{start_z} F1500

 ## Wipe nozzle
 {% for wipes in range(1, (wipe_qty + 1)) %}
   G1 X{start_x + wipe_dist} F{wipe_spd * 60}
   G1 X{start_x} F{wipe_spd * 60}
 {% endfor %}

 ## Raise nozzle
 G1 Z{raise_distance}

#####################################################################
#####################################################################

[gcode_macro CHANGE_FILAMENT_MACRO]
description: Heat to 260, move to purge spot, purge there, ooze, cool to 220, clean, then home.
# --- Tweaks ---
variable_purge_temp: 260      # °C for melting/ooze
variable_clean_temp: 220      # °C for brushing
variable_purge_amount: 125    # mm to extrude at purge spot
variable_extrude_feed: 300    # mm/min   (≈5 mm/s)
variable_travel_feed: 6000    # mm/min   (≈100 mm/s)
variable_wait_sec: 150000     # 150 seconds to wait/ooze
variable_purge_x: 300         
variable_purge_y: 350         # Purge Locations
variable_purge_z: 100
gcode:
    SAVE_GCODE_STATE NAME=CF_STATE
    G90                         ; absolute XYZ
    M83                         ; relative E
    {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}

    ; Go to purge location first
    G1 X{purge_x} Y{purge_y} Z{purge_z} F{travel_feed}
    
    ; Heat to purge temp and wait
    M109 S{purge_temp}

    ; Purge at the spot
    G1 E{purge_amount} F{extrude_feed}

    ; Let it ooze at high temp
    G4 S{wait_sec}

    ; Cool to cleaning temp and wait
    M109 S{clean_temp}

    ; Brush/clean
    CLEAN_NOZZLE

    ; Final home
    G28
    G1 Z60 F{travel_feed}
    
    RESTORE_GCODE_STATE NAME=CF_STATE